#!/bin/bash

set -eo pipefail

git add -N .
diff=$(git diff)

if [ -z "$diff" ]; then
  exit 0
fi

: "${ANTHROPIC_API_KEY:?must be set}"

max_chars=100000
if [ ${#diff} -gt $max_chars ]; then
  diff="${diff:0:$max_chars}

... (diff truncated)"
fi

prompt='You are reviewing a diff of an auto-generated Ruby SDK that wraps the Tremendous API (generated from an OpenAPI spec).

Write a PR description as a list of conventional commit lines summarizing the meaningful API changes. Each line must use a type prefix: feat, fix, docs, or chore.

Rules:
- One line per distinct change, no blank lines between them
- Each line MUST be at most 70 characters (including the type prefix). This is critical because GitHub squash merges wrap lines at ~72 chars, which breaks Release Please changelog parsing.
- No bullet points, no dashes, no markdown headers, no prose
- Use backticks for code references (field names, endpoints, enum values)
- Be specific: mention endpoint paths, field names or enum values when relevant
- Omit implementation details, like class names. Use resource names like "Reward" or "Product" instead.
- Ignore auto-generated boilerplate (module declarations, require statements, etc.)
- Group related small changes into a single line when appropriate

Examples of good output:

feat: add create field endpoint (POST /fields)
feat: add data_type enum validation for fields (Checkbox, Currency, Date, Dropdown, Email, List, Number, Phone, Text, TextArea)
fix: type field data as structured object instead of untyped hash

feat: add new Topups API (create, get, list)
feat: add currency support to invoices (USD, EUR, GBP)
fix: update redemption method enum values
fix: make funding source meta fields nullable

feat: add `expires_at` to Rewards
fix: remove `BGN` currency code reference'

jq -n \
  --arg prompt "$prompt" \
  --arg diff "$diff" \
  '{
    model: "claude-opus-4-6",
    max_tokens: 1024,
    system: $prompt,
    messages: [
      {role: "user", content: $diff}
    ]
  }' \
| curl -sf --retry 2 https://api.anthropic.com/v1/messages \
    -H "x-api-key: ${ANTHROPIC_API_KEY}" \
    -H "anthropic-version: 2023-06-01" \
    -H "Content-Type: application/json" \
    -d @- \
| jq -r '.content[0].text'
